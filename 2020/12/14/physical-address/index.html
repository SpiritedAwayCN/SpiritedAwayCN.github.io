<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>输出虚拟地址对应物理地址的程序 - SpiritedAwayCN&#039;s Homepage</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="SpiritedAwayCN&#039;s Homepage"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="SpiritedAwayCN&#039;s Homepage"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="这是一个可以在程序内输出本进程中虚拟地址实际对应的物理地址，可以用来探究linux内存管理系统。注意：由于一些原因，此程序未能找到在lab machine上成功运行的方法，因此需要在虚拟机上运行。 文件结构1234vm.h vm.c	- 实现了由虚拟地址计算物理地址的函数，请勿修改cow.c	    - 测试copy on write的程序global.c	- 测试.bss段映射匿名文件的程序mm"><meta property="og:type" content="blog"><meta property="og:title" content="输出虚拟地址对应物理地址的程序"><meta property="og:url" content="http://spiritedawaycn.github.io/2020/12/14/physical-address/"><meta property="og:site_name" content="SpiritedAwayCN&#039;s Homepage"><meta property="og:description" content="这是一个可以在程序内输出本进程中虚拟地址实际对应的物理地址，可以用来探究linux内存管理系统。注意：由于一些原因，此程序未能找到在lab machine上成功运行的方法，因此需要在虚拟机上运行。 文件结构1234vm.h vm.c	- 实现了由虚拟地址计算物理地址的函数，请勿修改cow.c	    - 测试copy on write的程序global.c	- 测试.bss段映射匿名文件的程序mm"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://spiritedawaycn.github.io/img/og_image.png"><meta property="article:published_time" content="2020-12-14T05:41:44.000Z"><meta property="article:modified_time" content="2020-12-14T11:47:31.059Z"><meta property="article:author" content="SpiritedAwayCN"><meta property="article:tag" content="代码"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://spiritedawaycn.github.io/2020/12/14/physical-address/"},"headline":"SpiritedAwayCN's Homepage","image":["http://spiritedawaycn.github.io/img/og_image.png"],"datePublished":"2020-12-14T05:41:44.000Z","dateModified":"2020-12-14T11:47:31.059Z","author":{"@type":"Person","name":"SpiritedAwayCN"},"description":"这是一个可以在程序内输出本进程中虚拟地址实际对应的物理地址，可以用来探究linux内存管理系统。注意：由于一些原因，此程序未能找到在lab machine上成功运行的方法，因此需要在虚拟机上运行。 文件结构1234vm.h vm.c\t- 实现了由虚拟地址计算物理地址的函数，请勿修改cow.c\t    - 测试copy on write的程序global.c\t- 测试.bss段映射匿名文件的程序mm"}</script><link rel="canonical" href="http://spiritedawaycn.github.io/2020/12/14/physical-address/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="SpiritedAwayCN&#039;s Homepage" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/2020/11/17/About-me">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-14T05:41:44.000Z" title="2020-12-14T05:41:44.000Z">2020-12-14</time>发表</span><span class="level-item"><time dateTime="2020-12-14T11:47:31.059Z" title="2020-12-14T11:47:31.059Z">2020-12-14</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Ideas/">Ideas</a></span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">输出虚拟地址对应物理地址的程序</h1><div class="content"><p>这是一个可以在程序内输出本进程中虚拟地址实际对应的物理地址，可以用来探究linux内存管理系统。<br><strong>注意：</strong>由于<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v4.19/admin-guide/mm/pagemap.html">一些原因</a>，此程序未能找到在lab machine上成功运行的方法，因此需要在虚拟机上运行。</p>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vm.h vm.c	- 实现了由虚拟地址计算物理地址的函数，请勿修改</span><br><span class="line">cow.c	    - 测试copy on write的程序</span><br><span class="line">global.c	- 测试.bss段映射匿名文件的程序</span><br><span class="line">mmap.c	    - 测试mmap函数有关操作的程序</span><br></pre></td></tr></table></figure>

<p>其中，<code>vm.h</code>与<code>vm.c</code>核心代码来源于网络，为了方便调用，此处做了适当的微调与封装。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="函数接口"><a href="#函数接口" class="headerlink" title="函数接口"></a>函数接口</h3><p>在<code>vm.h</code>与<code>vm.c</code>中，封装了一个函数，其可以根据传入的虚拟地址输出物理地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_pa</span><span class="params">(<span class="keyword">void</span>* va, <span class="keyword">const</span> <span class="keyword">char</span>* info)</span></span>;</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h4 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h4><p>va - 需要查看其物理地址的虚拟地址<br>info - 输出时首先输出的字符串，方便查看；如果为空字符串，则改为输出进程号</p>
<h4 id="函数效果"><a href="#函数效果" class="headerlink" title="函数效果"></a>函数效果</h4><p>会按如下格式输出一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;info&#125;: virtual addr &#x3D; &#123;va&#125;, physical addr &#x3D; &#123;pa&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>info</code>为空串，则<code>&#123;info&#125;</code>会替换为<code>pid = &#123;进程号&#125;</code>；<br>如果物理地址转化成功，则<code>&#123;pa&#125;</code>为16进制物理地址，否则为错误信息（包括缺页、权限不足失败等）。</p>
<h3 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h3><p>新建一个<code>.c</code>文件，包含<code>vm.h</code>头文件后即可直接调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;vm.c&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>可以在自己的代码中调用此函数观察某些变量的物理地址。</p>
<h3 id="实例：cow-c"><a href="#实例：cow-c" class="headerlink" title="实例：cow.c"></a>实例：cow.c</h3><p>一个简单的例子，其<code>fork</code>出一个子进程，最初两个进程同一变量的物理地址一致，而父进程写变量时发生写时复制，父进程该变量的物理地址变化。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* copy on write */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&quot;vm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;	<span class="comment">/* child */</span></span><br><span class="line">        show_pa((<span class="keyword">void</span>*)&amp;c, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        show_pa((<span class="keyword">void</span>*)&amp;c, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;			<span class="comment">/* parent */</span></span><br><span class="line">        sleep(<span class="number">1</span>); </span><br><span class="line">        show_pa((<span class="keyword">void</span>*)&amp;c, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        c = <span class="number">20</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent: modified c.\n&quot;</span>);</span><br><span class="line">        show_pa((<span class="keyword">void</span>*)&amp;c, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>由于<code>show_pa</code>函数的定义在<code>vm.c</code>中，因此编译命令需要包含<code>vm.c</code>，以编译上述<code>cow.c</code>为例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc cow.c vm.c -g -Wall -o vm</span><br></pre></td></tr></table></figure>

<p>将得到名为<code>vm</code>的可执行文件。</p>
<h3 id="运行-（重要！）"><a href="#运行-（重要！）" class="headerlink" title="运行 （重要！）"></a>运行 （重要！）</h3><p>如果直接运行出现了如下情况（以上述<code>cow.c</code>编译出的可执行文件<code>vm</code>为例）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pid &#x3D; 52128: virtual addr &#x3D; 0x55d38e576010, physical addr &#x3D; 10</span><br><span class="line">pid &#x3D; 52127: virtual addr &#x3D; 0x55d38e576010, physical addr &#x3D; 10</span><br><span class="line">parent: modified c.</span><br><span class="line">pid &#x3D; 52127: virtual addr &#x3D; 0x55d38e576010, physical addr &#x3D; 10</span><br><span class="line">pid &#x3D; 52128: virtual addr &#x3D; 0x55d38e576010, physical addr &#x3D; 10</span><br></pre></td></tr></table></figure>

<p>物理地址最多只有3个16进制数，不足4KB，即只输出了页内偏移。这是<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v4.19/admin-guide/mm/pagemap.html">权限原因</a>导致的，在lab machine上未能找到解决方案，但在自己的虚拟机/双系统上可以解决。</p>
<p>如果编译出的可执行文件为<code>vm</code>，则可以通过如下指令运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">setcap</span> cap_sys_admin=eip vm</span><br><span class="line">$ sudo ./vm</span><br></pre></td></tr></table></figure>

<p>其中，第一条命令在<strong>每次编译</strong>后需要运行，若先前已运行过且没有重新编译则不需要。<strong>注意</strong>：两条命令<code>sudo</code>都是必要的。以此法的运行结果如下（每次运行可能不同）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pid &#x3D; 52128: virtual addr &#x3D; 0x55d38e576010, physical addr &#x3D; 26541010</span><br><span class="line">pid &#x3D; 52127: virtual addr &#x3D; 0x55d38e576010, physical addr &#x3D; 26541010</span><br><span class="line">parent: modified c.</span><br><span class="line">pid &#x3D; 52127: virtual addr &#x3D; 0x55d38e576010, physical addr &#x3D; 52376010</span><br><span class="line">pid &#x3D; 52128: virtual addr &#x3D; 0x55d38e576010, physical addr &#x3D; 26541010</span><br></pre></td></tr></table></figure>

<p>可以观察到：父进程<code>52127</code>在修改了变量<code>c</code>的值后发生了写时复制。</p>
<h2 id="更多实例"><a href="#更多实例" class="headerlink" title="更多实例"></a>更多实例</h2><h3 id="global-c"><a href="#global-c" class="headerlink" title="global.c"></a>global.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* anonymous file and CoW */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&quot;vm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEN 1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF 1024</span></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[LEN][LEN];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[BUF];</span><br><span class="line">    <span class="comment">// printf(&quot;array = %p\n&quot;, array);</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">4</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buffer, <span class="string">&quot;array[%d][0]&quot;</span>, i);</span><br><span class="line">        show_pa(&amp;<span class="built_in">array</span>[i][<span class="number">0</span>], buffer); <span class="comment">/* page not present */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; LEN; i++)</span><br><span class="line">        sum += <span class="built_in">array</span>[i][<span class="number">0</span>]; <span class="comment">/* read but not write */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sum = %d\n&quot;</span>, sum);<span class="comment">/* Avoid being optimized out */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">4</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buffer, <span class="string">&quot;array[%d][0]&quot;</span>, i);</span><br><span class="line">        show_pa(&amp;<span class="built_in">array</span>[i][<span class="number">0</span>], buffer); <span class="comment">/* page present */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = LEN - <span class="number">4</span>; i &lt; LEN; i++)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buffer, <span class="string">&quot;array[%d][0]&quot;</span>, i);</span><br><span class="line">        show_pa(&amp;<span class="built_in">array</span>[i][<span class="number">0</span>], buffer); <span class="comment">/* page present */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">4</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">array</span>[i][<span class="number">0</span>] = (i<span class="number">-1</span>)*(i<span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(buffer, <span class="string">&quot;modified array[%d][0]&quot;</span>, i);</span><br><span class="line">        show_pa(&amp;<span class="built_in">array</span>[i][<span class="number">0</span>], buffer); <span class="comment">/* copy on write */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = LEN - <span class="number">4</span>; i &lt; LEN; i++)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buffer, <span class="string">&quot;array[%d][0]&quot;</span>, i);</span><br><span class="line">        show_pa(&amp;<span class="built_in">array</span>[i][<span class="number">0</span>], buffer); <span class="comment">/* not changed */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先定义了一个较大的全局变量<code>int array[1024][1024]</code>，注意<code>array[i][0]</code>与<code>array[i+1][0]</code>正好相差4KB。</p>
<p>之后执行如下过程：</p>
<ol>
<li>直接查看它们的物理地址（缺页）</li>
<li>经过一趟读操作后查看它们的物理地址</li>
<li>对部分进行写操作后查看它们的物理地址</li>
</ol>
<p>详细细节请参阅源代码，其可能的输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">array[1][0]: virtual addr &#x3D; 0x55d619f68040, physical addr &#x3D; page present is 0</span><br><span class="line">array[2][0]: virtual addr &#x3D; 0x55d619f69040, physical addr &#x3D; page present is 0</span><br><span class="line">array[3][0]: virtual addr &#x3D; 0x55d619f6a040, physical addr &#x3D; page present is 0</span><br><span class="line">array[4][0]: virtual addr &#x3D; 0x55d619f6b040, physical addr &#x3D; page present is 0</span><br><span class="line">sum &#x3D; 0</span><br><span class="line">array[1][0]: virtual addr &#x3D; 0x55d619f68040, physical addr &#x3D; 23f19040</span><br><span class="line">array[2][0]: virtual addr &#x3D; 0x55d619f69040, physical addr &#x3D; 23f19040</span><br><span class="line">array[3][0]: virtual addr &#x3D; 0x55d619f6a040, physical addr &#x3D; 23f19040</span><br><span class="line">array[4][0]: virtual addr &#x3D; 0x55d619f6b040, physical addr &#x3D; 23f19040</span><br><span class="line">array[1020][0]: virtual addr &#x3D; 0x55d61a363040, physical addr &#x3D; 23f19040</span><br><span class="line">array[1021][0]: virtual addr &#x3D; 0x55d61a364040, physical addr &#x3D; 23f19040</span><br><span class="line">array[1022][0]: virtual addr &#x3D; 0x55d61a365040, physical addr &#x3D; 23f19040</span><br><span class="line">array[1023][0]: virtual addr &#x3D; 0x55d61a366040, physical addr &#x3D; 23f19040</span><br><span class="line">modified array[1][0]: virtual addr &#x3D; 0x55d619f68040, physical addr &#x3D; 6c06e040</span><br><span class="line">modified array[2][0]: virtual addr &#x3D; 0x55d619f69040, physical addr &#x3D; 11bb9040</span><br><span class="line">modified array[3][0]: virtual addr &#x3D; 0x55d619f6a040, physical addr &#x3D; 4f7af040</span><br><span class="line">modified array[4][0]: virtual addr &#x3D; 0x55d619f6b040, physical addr &#x3D; 75b67040</span><br><span class="line">array[1020][0]: virtual addr &#x3D; 0x55d61a363040, physical addr &#x3D; 23f19040</span><br><span class="line">array[1021][0]: virtual addr &#x3D; 0x55d61a364040, physical addr &#x3D; 23f19040</span><br><span class="line">array[1022][0]: virtual addr &#x3D; 0x55d61a365040, physical addr &#x3D; 23f19040</span><br><span class="line">array[1023][0]: virtual addr &#x3D; 0x55d61a366040, physical addr &#x3D; 23f19040</span><br></pre></td></tr></table></figure>

<p>注意到，在经历读写操作前是缺页状态（前4行<code>array[1][0]-array[4][0]</code>），但修改程序后发现<code>array[0][0]</code>在读写前并未缺页，请思考可能的原因。</p>
<h3 id="mmap-c"><a href="#mmap-c" class="headerlink" title="mmap.c"></a>mmap.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&quot;vm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* private1 = (<span class="keyword">char</span>*)mmap(<span class="number">0</span>, <span class="number">128</span>, PROT_READ|PROT_WRITE, MAP_ANON|MAP_PRIVATE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span>* private2 = (<span class="keyword">char</span>*)mmap(<span class="number">0</span>, <span class="number">128</span>, PROT_READ|PROT_WRITE, MAP_ANON|MAP_PRIVATE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span>* shared = (<span class="keyword">char</span>*)mmap(<span class="number">0</span>, <span class="number">128</span>, PROT_READ|PROT_WRITE, MAP_ANON|MAP_SHARED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    show_pa(private1, <span class="string">&quot;private1&quot;</span>); <span class="comment">/* not present */</span></span><br><span class="line">    show_pa(private2, <span class="string">&quot;private2&quot;</span>); <span class="comment">/* not present */</span></span><br><span class="line">    show_pa(shared, <span class="string">&quot;shared&quot;</span>); <span class="comment">/* not present */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;char: %d %d %d\n&quot;</span>, (<span class="keyword">int</span>)private1[<span class="number">0</span>], (<span class="keyword">int</span>)private2[<span class="number">0</span>] ,(<span class="keyword">int</span>)shared[<span class="number">0</span>]); <span class="comment">/* read */</span></span><br><span class="line"></span><br><span class="line">    show_pa(private1, <span class="string">&quot;private1&quot;</span>); </span><br><span class="line">    show_pa(private2, <span class="string">&quot;private2&quot;</span>); <span class="comment">/* private1 = private2 */</span></span><br><span class="line">    show_pa(shared, <span class="string">&quot;shared&quot;</span>); <span class="comment">/* shared != private*/</span></span><br><span class="line"></span><br><span class="line">    private2[<span class="number">0</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;modified private2\n&quot;</span>);</span><br><span class="line">    show_pa(private2, <span class="string">&quot;private2&quot;</span>); <span class="comment">/* copy on write */</span></span><br><span class="line"></span><br><span class="line">    private1[<span class="number">0</span>] = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;modified private1\n&quot;</span>);</span><br><span class="line">    show_pa(private1, <span class="string">&quot;private1&quot;</span>); <span class="comment">/* changed */</span></span><br><span class="line"></span><br><span class="line">    shared[<span class="number">0</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;modified shared\n&quot;</span>);</span><br><span class="line">    show_pa(shared, <span class="string">&quot;shared&quot;</span>); <span class="comment">/* not changed */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fork!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid)&#123; <span class="comment">/* parent */</span></span><br><span class="line">        show_pa(private1, <span class="string">&quot;[parent]private1&quot;</span>);</span><br><span class="line">        show_pa(shared, <span class="string">&quot;[parent]shared&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">/* step 2 */</span></span><br><span class="line">        show_pa(private1, <span class="string">&quot;[parent]private1&quot;</span>); <span class="comment">/* not changed */</span></span><br><span class="line">        show_pa(shared, <span class="string">&quot;[parent]shared&quot;</span>); <span class="comment">/* not changed */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[parent]private1 = %c, shared = %c\n&quot;</span>, private1[<span class="number">0</span>], shared[<span class="number">0</span>]);<span class="comment">/* private1 not changed, shared changed*/</span></span><br><span class="line"></span><br><span class="line">        private1[<span class="number">0</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[parent]modified private1\n&quot;</span>);</span><br><span class="line">        show_pa(private1, <span class="string">&quot;[parent]private1&quot;</span>); <span class="comment">/* not changed (refcnt==1)*/</span></span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">/* child */</span></span><br><span class="line">        show_pa(private1, <span class="string">&quot;[child]private1&quot;</span>);</span><br><span class="line">        show_pa(shared, <span class="string">&quot;[child]shared&quot;</span>); <span class="comment">/* not present */</span></span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">char</span> c = shared[<span class="number">0</span>]; <span class="comment">/* read */</span></span><br><span class="line">        show_pa(shared, <span class="string">&quot;[child]shared&quot;</span>); <span class="comment">/* same as parent */</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">/* step 1 */</span></span><br><span class="line">        private1[<span class="number">0</span>] = <span class="string">&#x27;c&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[child]modified private1\n&quot;</span>);</span><br><span class="line">        shared[<span class="number">0</span>] = c + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[child]modified shared\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[child]private1 = %c, shared = %c\n&quot;</span>, private1[<span class="number">0</span>], shared[<span class="number">0</span>]);</span><br><span class="line">        show_pa(private1, <span class="string">&quot;[child]private1&quot;</span>); <span class="comment">/* copy on write */</span></span><br><span class="line">        show_pa(shared, <span class="string">&quot;[child]shared&quot;</span>); <span class="comment">/* not changed */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wait(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此程序mmap了两个私有页与一个共享页，并通过fork观察私有页与共享页在写时复制的区别，具体过程请见源代码。</p>
<p>值得注意的是，此程序fork后，子进程先写私有页触发写时复制，而后父进程写同一变量时并未发生复制，这表明内核维护了私有页面的引用数，若引用数为1则不会复制。</p>
<p>以下是一个可能的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private1: virtual addr &#x3D; 0x7fb9ab92c000, physical addr &#x3D; page present is 0</span><br><span class="line">private2: virtual addr &#x3D; 0x7fb9ab92b000, physical addr &#x3D; page present is 0</span><br><span class="line">shared: virtual addr &#x3D; 0x7fb9ab92a000, physical addr &#x3D; page present is 0</span><br><span class="line">char: 0 0 0</span><br><span class="line">private1: virtual addr &#x3D; 0x7fb9ab92c000, physical addr &#x3D; 23f19000</span><br><span class="line">private2: virtual addr &#x3D; 0x7fb9ab92b000, physical addr &#x3D; 23f19000</span><br><span class="line">shared: virtual addr &#x3D; 0x7fb9ab92a000, physical addr &#x3D; 11a64000</span><br><span class="line">modified private2</span><br><span class="line">private2: virtual addr &#x3D; 0x7fb9ab92b000, physical addr &#x3D; 43336000</span><br><span class="line">modified private1</span><br><span class="line">private1: virtual addr &#x3D; 0x7fb9ab92c000, physical addr &#x3D; 71994000</span><br><span class="line">modified shared</span><br><span class="line">shared: virtual addr &#x3D; 0x7fb9ab92a000, physical addr &#x3D; 11a64000</span><br><span class="line">fork!</span><br><span class="line">[parent]private1: virtual addr &#x3D; 0x7fb9ab92c000, physical addr &#x3D; 71994000</span><br><span class="line">[parent]shared: virtual addr &#x3D; 0x7fb9ab92a000, physical addr &#x3D; 11a64000</span><br><span class="line">[child]private1: virtual addr &#x3D; 0x7fb9ab92c000, physical addr &#x3D; 71994000</span><br><span class="line">[child]shared: virtual addr &#x3D; 0x7fb9ab92a000, physical addr &#x3D; page present is 0</span><br><span class="line">[child]shared: virtual addr &#x3D; 0x7fb9ab92a000, physical addr &#x3D; 11a64000</span><br><span class="line">[child]modified private1</span><br><span class="line">[child]modified shared</span><br><span class="line">[child]private1 &#x3D; c, shared &#x3D; B</span><br><span class="line">[child]private1: virtual addr &#x3D; 0x7fb9ab92c000, physical addr &#x3D; 1e920000</span><br><span class="line">[child]shared: virtual addr &#x3D; 0x7fb9ab92a000, physical addr &#x3D; 11a64000</span><br><span class="line">[parent]private1: virtual addr &#x3D; 0x7fb9ab92c000, physical addr &#x3D; 71994000</span><br><span class="line">[parent]shared: virtual addr &#x3D; 0x7fb9ab92a000, physical addr &#x3D; 11a64000</span><br><span class="line">[parent]private1 &#x3D; b, shared &#x3D; B</span><br><span class="line">[parent]modified private1</span><br><span class="line">[parent]private1: virtual addr &#x3D; 0x7fb9ab92c000, physical addr &#x3D; 71994000</span><br></pre></td></tr></table></figure>

<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="vm-h"><a href="#vm-h" class="headerlink" title="vm.h"></a>vm.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * show physical address of given va</span></span><br><span class="line"><span class="comment"> * params:</span></span><br><span class="line"><span class="comment"> *   va   - vitural address</span></span><br><span class="line"><span class="comment"> *   info - a string will be printed at beginning, current</span></span><br><span class="line"><span class="comment"> *        process id will be printed instead if empty</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_pa</span><span class="params">(<span class="keyword">void</span>* va, <span class="keyword">const</span> <span class="keyword">char</span>* info)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="vm-c"><a href="#vm-c" class="headerlink" title="vm.c"></a>vm.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Do not modify this file unless you know what you are doing */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXBUF 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//计算虚拟地址对应的地址，传入虚拟地址vaddr，通过paddr传出物理地址</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">mem_addr</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> vaddr, <span class="keyword">unsigned</span> <span class="keyword">long</span> *paddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pageSize = getpagesize();<span class="comment">//调用此函数获取系统设定的页面大小</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> v_pageIndex = vaddr / pageSize;<span class="comment">//计算此虚拟地址相对于0x0的经过的页面数</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> v_offset = v_pageIndex * <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);<span class="comment">//计算在/proc/pid/page_map文件中的偏移量</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> page_offset = vaddr % pageSize;<span class="comment">//计算虚拟地址在页面中的偏移量</span></span><br><span class="line">    <span class="keyword">uint64_t</span> item = <span class="number">0</span>;<span class="comment">//存储对应项的值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<span class="comment">//以只读方式打开/proc/pid/page_map</span></span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>)<span class="comment">//判断是否打开失败</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;open /proc/self/pagemap error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(lseek(fd, v_offset, SEEK_SET) == <span class="number">-1</span>)<span class="comment">//将游标移动到相应位置，即对应项的起始地址且判断是否移动失败</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;sleek error&quot;</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(read(fd, &amp;item, <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)) != <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>))<span class="comment">//读取对应项的值，并存入item中，且判断读取数据位数是否正确</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;read item error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">63</span>) &amp; item) == <span class="number">0</span>)<span class="comment">//判断present是否为0</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;page present is 0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> phy_pageIndex = (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>) &amp; item;<span class="comment">//计算物理页号，即取item的bit0-54</span></span><br><span class="line"></span><br><span class="line">    *paddr = (phy_pageIndex * pageSize) + page_offset;<span class="comment">//再加上页内偏移量就得到了物理地址</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_pa</span><span class="params">(<span class="keyword">void</span>* va, <span class="keyword">const</span> <span class="keyword">char</span>* str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pa = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* msg = mem_addr((<span class="keyword">unsigned</span> <span class="keyword">long</span>)va, &amp;pa);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(str) == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pid = %d: virtual addr = %p, &quot;</span>, getpid(), va);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s: virtual addr = %p, &quot;</span>, str, va);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(msg))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;physical addr = %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;physical addr = %lx\n&quot;</span>, pa);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>输出虚拟地址对应物理地址的程序</p><p><a href="http://spiritedawaycn.github.io/2020/12/14/physical-address/">http://spiritedawaycn.github.io/2020/12/14/physical-address/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>SpiritedAwayCN</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-12-14</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-12-14</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a><a class="icon" rel="noopener" target="_blank" title="ShareAlike" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-creative-commons-sa"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E4%BB%A3%E7%A0%81/">代码</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5fb48effefe98e0012650837&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/12/14/Notes-of-Fourier-Transform/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">【终结】一份傅里叶笔记</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/11/28/Fourier-Transform/"><span class="level-item">DFS, DTFT与DFT</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpg" alt="石淳安"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">石淳安</p><p class="is-size-6 is-block">SpiritedAwayCN</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">7</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/SpiritedAwayCN" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/SpiritedAwayCN"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://www.facebook.com/profile.php?id=100033199519420"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/SpiritedAwayCN"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Zhihu" href="https://www.zhihu.com/people/spiritedaway-91"><i class="fab fa-quora"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Telegram" href="https://t.me/SpiritedAwayCN"><i class="fab fa-telegram"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#文件结构"><span class="level-left"><span class="level-item">1</span><span class="level-item">文件结构</span></span></a></li><li><a class="level is-mobile" href="#使用方法"><span class="level-left"><span class="level-item">2</span><span class="level-item">使用方法</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#函数接口"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">函数接口</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#函数参数"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">函数参数</span></span></a></li><li><a class="level is-mobile" href="#函数效果"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">函数效果</span></span></a></li></ul></li><li><a class="level is-mobile" href="#调用方法"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">调用方法</span></span></a></li><li><a class="level is-mobile" href="#实例：cow-c"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">实例：cow.c</span></span></a></li><li><a class="level is-mobile" href="#编译"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">编译</span></span></a></li><li><a class="level is-mobile" href="#运行-（重要！）"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">运行 （重要！）</span></span></a></li></ul></li><li><a class="level is-mobile" href="#更多实例"><span class="level-left"><span class="level-item">3</span><span class="level-item">更多实例</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#global-c"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">global.c</span></span></a></li><li><a class="level is-mobile" href="#mmap-c"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">mmap.c</span></span></a></li></ul></li><li><a class="level is-mobile" href="#附录"><span class="level-left"><span class="level-item">4</span><span class="level-item">附录</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#vm-h"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">vm.h</span></span></a></li><li><a class="level is-mobile" href="#vm-c"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">vm.c</span></span></a></li></ul></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://space.bilibili.com/267098354" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili</span></span><span class="level-right"><span class="level-item tag">space.bilibili.com</span></span></a></li><li><a class="level is-mobile" href="https://music.163.com/#/user/home?id=1348689482" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Netease-Cloud-Music</span></span><span class="level-right"><span class="level-item tag">music.163.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Ideas/"><span class="level-start"><span class="level-item">Ideas</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Minecraft/"><span class="level-start"><span class="level-item">Minecraft</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-12-17T15:27:10.000Z">2020-12-17</time></p><p class="title"><a href="/2020/12/17/Minecraft-and-Me/">Minecraft——我心中的瓦尔登湖</a></p><p class="categories"><a href="/categories/Minecraft/">Minecraft</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-12-14T11:43:59.000Z">2020-12-14</time></p><p class="title"><a href="/2020/12/14/Notes-of-Fourier-Transform/">【终结】一份傅里叶笔记</a></p><p class="categories"><a href="/categories/Ideas/">Ideas</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-12-14T05:41:44.000Z">2020-12-14</time></p><p class="title"><a href="/2020/12/14/physical-address/">输出虚拟地址对应物理地址的程序</a></p><p class="categories"><a href="/categories/Ideas/">Ideas</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-11-28T09:35:03.000Z">2020-11-28</time></p><p class="title"><a href="/2020/11/28/Fourier-Transform/">DFS, DTFT与DFT</a></p><p class="categories"><a href="/categories/Ideas/">Ideas</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-11-24T15:44:11.000Z">2020-11-24</time></p><p class="title"><a href="/2020/11/24/Recusive-Theorem/">递归定理——输出自身源代码的程序</a></p><p class="categories"><a href="/categories/Ideas/">Ideas</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AstroMC/"><span class="tag">AstroMC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NPC/"><span class="tag">NPC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TCS/"><span class="tag">TCS</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BB%A3%E7%A0%81/"><span class="tag">代码</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%9D%E7%BB%AA/"><span class="tag">思绪</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E7%90%86%E5%9F%BA%E7%A1%80/"><span class="tag">数理基础</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%AD%94%E5%A1%94/"><span class="tag">魔塔</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="SpiritedAwayCN&#039;s Homepage" height="28"></a><p class="is-size-7"><span>&copy; 2020 SpiritedAwayCN</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>